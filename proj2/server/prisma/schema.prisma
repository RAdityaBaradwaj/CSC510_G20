generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  RESTAURANT
}

model User {
  id             String                @id @default(uuid())
  email          String                @unique
  passwordHash   String
  role           UserRole              @default(CUSTOMER)
  name           String
  vehicleType    String?
  restaurants    Restaurant[]
  menuItemLogs   MenuItemChangeLog[]   @relation("MenuItemChangeLogUser")
  customerOrders Order[]               @relation("CustomerOrders")
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model Restaurant {
  id           String               @id @default(uuid())
  ownerUser    User                 @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  ownerUserId  String
  name         String
  address      String
  latitude     Float?
  longitude    Float?
  isActive     Boolean              @default(true)
  sections     MenuSection[]
  menuItems    MenuItem[]
  changeLogs   MenuItemChangeLog[]
  orders       Order[]              @relation("RestaurantOrders")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([ownerUserId])
  @@index([isActive])
}

model MenuSection {
  id           String     @id @default(uuid())
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId String
  title        String
  position     Int         @default(0)
  items        MenuItem[]

  @@index([restaurantId])
  @@unique([restaurantId, title])
}

model MenuItem {
  id            String        @id @default(uuid())
  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId  String
  section       MenuSection?  @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  sectionId     String?
  name          String
  description   String        @default("")
  priceCents    Int
  isAvailable   Boolean       @default(true)
  tags          String[]      @default([])
  changeLogs    MenuItemChangeLog[]
  orderItems    OrderItem[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([restaurantId])
  @@index([sectionId])
  @@index([isAvailable])
}

enum MenuItemAction {
  CREATE
  UPDATE
  DELETE
}

model MenuItemChangeLog {
  id            String          @id @default(uuid())
  restaurant    Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId  String
  menuItem      MenuItem        @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  menuItemId    String
  user          User?           @relation("MenuItemChangeLogUser", fields: [userId], references: [id], onDelete: SetNull)
  userId        String?
  action        MenuItemAction
  beforeJSON    Json?
  afterJSON     Json?
  createdAt     DateTime        @default(now())

  @@index([restaurantId])
  @@index([menuItemId])
  @@index([action])
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELED
}

model Order {
  id             String      @id @default(uuid())
  customer       User        @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: Cascade)
  customerId     String
  restaurant     Restaurant  @relation("RestaurantOrders", fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId   String
  status         OrderStatus @default(PENDING)
  pickupEtaMin   Int
  routeOrigin    String
  routeDestination String
  totalCents     Int
  items          OrderItem[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([customerId])
  @@index([restaurantId])
  @@index([status])
}

model OrderItem {
  id          String   @id @default(uuid())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId  String
  quantity    Int      @default(1)
  priceCents  Int
}
